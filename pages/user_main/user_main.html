<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>SHARK</title>
		<link rel="stylesheet" type="text/css" href="user_main.css"/>
		
		<script src="../url_config.js"></script>
		<script src="../vue.js"></script>
		<script src="../jquery.js"></script>
		<script src="../axios.js"></script>
		<script src="../md5.js"></script>
	</head>
	<body>
		
		<div class="left animation_time" id="left_menu">
			<div style="text-align: center; width: inherit;">hello there {{user_name}}!</div>
		</div>
		
		<div class="main_container animation_time">
			<div id="heading" class="bg-gradient" id="heading">
				<div id="user" @click="toggle_left"></div>
				<div id="logo" onclick="location.href='../index/index.html'"></div>
				<div id="search" class="animation_time" @click="toggle_right"></div>
			</div>
			<div class="notification-container"></div>
			<input
			      id="pac-input"
			      class="controls"
			      type="text"
			      placeholder="目的地址搜索"
				  style="visibility: hidden;"
			    />
				
			<div class='info_container'></div>
			
			<div id="map"></div>
		</div>

		<div class="right animation_time" id="sidebar">
			<div id="search-area">
				<input type="text" type="text" placeholder="车位名搜索" required>
				<button type="button">搜索</button>
			</div>
			
			<div id="results-area">
				<ul> 
				<!-- TODO get uuid and basic info from backend -->
					<li id='4eb85e7c-81a5-4b74-9c42-b0c09c07a12c' onclick="info(this)">
					  <p class="p-name">公用学院苏州工业园区218号如果地址很长会不会溢出</p>
								<div class="row">
									<div class="location_icons"></div>
									<div class="content">苏州工业园区218号如果地址很长会不会溢出</div>
								</div>
								<div class="row">
									<div class="status_icons"></div>
									<div class="content">个人</div>
								</div>
								<div class="row">
									<div class="distance_icons"></div>
									<div class="content">69 KM</div>
								</div>
					</li>
					<li onclick="info(this)">
					  <p class="p-name">文萃广场</p>
								<div class="row">
									<div class="location_icons"></div>
									<div class="content">苏州工业园区218号如果地址很长会不会溢出</div>
								</div>
								<div class="row">
									<div class="status_icons"></div>
									<div class="content">物业</div>
								</div>
								<div class="row">
									<div class="distance_icons"></div>
									<div class="content">69 km</div>
								</div>
					</li>
					<li onclick="info(this)">
					  <p class="p-name">NUSRI</p>
								<div class="row">
									<div class="location_icons"></div>
									<div class="content">苏州工业园区218号如果地址很长会不会溢出</div>
								</div>
								<div class="row">
									<div class="status_icons"></div>
									<div class="content">物业</div>
								</div>
								<div class="row">
									<div class="distance_icons"></div>
									<div class="content">69 km</div>
								</div>
					</li>
					<li onclick="info(this)">
					  <p class="p-name">公用学院苏州工业园区218号如果地址很长会不会溢出</p>
								<div class="row">
									<div class="location_icons"></div>
									<div class="content">苏州工业园区218号如果地址很长会不会溢出</div>
								</div>
								<div class="row">
									<div class="status_icons"></div>
									<div class="content">个人</div>
								</div>
								<div class="row">
									<div class="distance_icons"></div>
									<div class="content">69 km</div>
								</div>
					</li>
					<li onclick="info(this)">
					  <p class="p-name">文萃广场</p>
								<div class="row">
									<div class="location_icons"></div>
									<div class="content">苏州工业园区218号如果地址很长会不会溢出</div>
								</div>
								<div class="row">
									<div class="status_icons"></div>
									<div class="content">物业</div>
								</div>
								<div class="row">
									<div class="distance_icons"></div>
									<div class="content">69 km</div>
								</div>
					</li>
					<li onclick="info(this)">
					  <p class="p-name">NUSRI</p>
								<div class="row">
									<div class="location_icons"></div>
									<div class="content">苏州工业园区218号如果地址很长会不会溢出</div>
								</div>
								<div class="row">
									<div class="status_icons"></div>
									<div class="content">物业</div>
								</div>
								<div class="row">
									<div class="distance_icons"></div>
									<div class="content">69 km</div>
								</div>
					</li>
					<li onclick="info(this)">
					  <p class="p-name">公用学院苏州工业园区218号如果地址很长会不会溢出</p>
								<div class="row">
									<div class="location_icons"></div>
									<div class="content">苏州工业园区218号如果地址很长会不会溢出</div>
								</div>
								<div class="row">
									<div class="status_icons"></div>
									<div class="content">个人</div>
								</div>
								<div class="row">
									<div class="distance_icons"></div>
									<div class="content">69 km</div>
								</div>
					</li>
					<li style="opacity: 0;">
					</li>
				</ul>
			</div>
		</div>
		<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBP7804kZZ1Gttz29wYqTWkdESYR2-az_0"></script> -->
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBP7804kZZ1Gttz29wYqTWkdESYR2-az_0&libraries=places"></script>
	</body>

<!-- script section -->
<script type="text/javascript">
// configure Vue
Vue.config.productionTip = false;
// configure baseURL
axios.defaults.baseURL = BaseURL;
// get notification section
notification = document.getElementsByClassName("notification-container")[0];
// left right sidebar logic
var l_status = false;
var r_status = false;
new Vue({
	el: "#heading",
	data:{
	},
	methods:{
		toggle_left(){
			if(r_status && !l_status){
				this.toggle_right();
			}
			l_status = !l_status;
			$('.left').toggleClass('expanded');
			$('.main_container').toggleClass('main_container_retracted');
		},
		toggle_right(){
			if(l_status && !r_status){
				this.toggle_left();
			}
			r_status = !r_status;
			$('.right').toggleClass('expanded');
			$('#search').toggleClass('icon_to_left');
			if(r_status){
				$('#pac-input')[0].style.marginLeft = '30vw';
				$('.notification-container')[0].style.width = '80vw';
				$('.notification-container')[0].style.right = '10vw';
				$('.info_container')[0].style.width = '80vw';
				$('.info_container')[0].style.right = '10vw';
			}
			else{
				$('#pac-input')[0].style.marginLeft = '40vw';
				$('.notification-container')[0].style.width = '0vw';
				$('.notification-container')[0].style.right = '0vw';
				$('.info_container')[0].style.width = '0vw';
				$('.info_container')[0].style.right = '0vw';
			}
		}
	}
});

// google map
// TODO TODO TODO

// // custom icon pic and resize
// var icon = {
//     url: "../index_pic/parking.png", // url
//     scaledSize: new google.maps.Size(46, 46), // scaled size
//     origin: new google.maps.Point(0,0), // origin
//     anchor: new google.maps.Point(0, 0) // anchor
// };
// // info display when click marker icon
// var infowindow = new google.maps.InfoWindow({
//                 content: "Add your popup content here"
// });
// // create marker instance on map
// var marker = new google.maps.Marker({
// 	// float number, parseFloat(sessionStorage.getItem('lat/lng'))
//     position: {lat: 120, lng: 120},
//     map,
//     icon: icon
//   });
// //  add infowindow to marker
// marker.addListener('click', function() {
//           infowindow.open(map, marker);
// });

//  temp info invoker
var active_li;
function info(self){
	if(active_li == self){
		close_panel();
		return;
	}
	if(active_li != null){
		close_panel();
	}
	// change content dynamically with returned list
	$('.info_container')[0].innerHTML = "<div class='info_panel'>"
											+"<button type='button' class='close_panel' onclick='close_panel()'>X</button>"
											+"<h3>"+self.innerText+"</h3>"
											+"<h4>拥有者:物业<h4>"
										+"</div>";
	active_li = self;
	self.style.boxShadow = "0 4px 4px rgb(0 0 0 / 40%), 0 -1px 0 rgb(0 0 0 / 2%)";
	self.style.background = "rgba(200,200,200, 0.9)";
}
// close information panel
function close_panel(){
	$('.info_container')[0].innerHTML = '';
	active_li.style.boxShadow = "";
	active_li.style.background = "";
	active_li = null;
}

var map;
function initMap(){
	if (navigator.geolocation) {
		// TODO swap in production
		map = new google.maps.Map(document.getElementById("map"), {
		    center: { lat: 0, lng: 0 },
		    zoom: 13,
			disableDefaultUI: true
		  });
		
		navigator.geolocation.getCurrentPosition(
			function (position) {
				map.setCenter({lat: position.coords.latitude, lng: position.coords.longitude});
			}
		);
		
		// Create the search box and link it to the UI element.
		const input = document.getElementById("pac-input");
		const searchBox = new google.maps.places.SearchBox(input);
		
		map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
		// Bias the SearchBox results towards current map's viewport.
		map.addListener("bounds_changed", () => {
		  searchBox.setBounds(map.getBounds());
		});
		
		let markers = [];
		
		// Listen for the event fired when the user selects a prediction and retrieve
		// more details for that place.
		// !!search and refocus event!!
		searchBox.addListener("places_changed", () => {
		  const places = searchBox.getPlaces();
		
		  if (places.length == 0) {
		    return;
		  }
		
		  // Clear out the old markers.
		  markers.forEach((marker) => {
		    marker.setMap(null);
		  });
		  markers = [];
		
		  // For each place, get the icon, name and location.
		  const bounds = new google.maps.LatLngBounds();
		
		  places.forEach((place) => {
		    if (!place.geometry || !place.geometry.location) {
		      console.log("Returned place contains no geometry");
		      return;
		    }
		
		    const icon = {
		      url: place.icon,
		      size: new google.maps.Size(71, 71),
		      origin: new google.maps.Point(0, 0),
		      anchor: new google.maps.Point(17, 34),
		      scaledSize: new google.maps.Size(25, 25),
		    };
		
		    // Create a marker for each place.
		    markers.push(
		      new google.maps.Marker({
		        map,
		        icon,
		        title: place.name,
		        position: place.geometry.location,
		      })
		    );
			
			// get lat and lng for searched location
			sessionStorage.setItem('lat', place.geometry.location.lat());
			sessionStorage.setItem('lng', place.geometry.location.lng());
			
		    if (place.geometry.viewport) {
		      // Only geocodes have viewport.
		      bounds.union(place.geometry.viewport);
		    } else {
		      bounds.extend(place.geometry.location);
		    }
		  });
		  map.fitBounds(bounds);
		});
		notification.innerHTML = '<div class="rectangle" id="success" style="display: flex; position: absolute;">'
									+'<div class="notification-text">'
										+'<span>&nbsp;&nbsp;Map load success.</span>'
									+'</div>'
								+'</div>';
	} 
	else{
		notification.innerHTML = '<div class="rectangle" id="error" style="display: flex; position: absolute;">'
									+'<div class="notification-text">'
										+'<span>&nbsp;&nbsp;Unable to get location.</span>'
									+'</div>'
								+'</div>';
	}
}



// TODO initiate map in production
// initMap();

new Vue({
	el: "#left_menu",
	data:{
		user_name : sessionStorage.getItem('user_name')
	},
	methods:{
		
	}
});

new Vue({
	el: "#sidebar",
	data:{
	},
	methods:{
	}
});

</script>

</html>
